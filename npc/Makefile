# Sanity check
ifeq ($(wildcard $(NPC_HOME)/src/main/csrc/npc-main.c),)
  $(error NPC_HOME=$(NPC_HOME) is not a NPC repo)
endif

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/include/config/auto.conf
-include $(NPC_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))

WORK_DIR          := .
BUILD_DIR         := $(WORK_DIR)/build
PRJ               := NPC

# Extract variabls from menuconfig
GUEST_ISA         ?= $(call remove_quote,$(CONFIG_ISA))
PLATFORM          ?= $(call remove_quote, $(CONFIG_PLATFORM))
ENGINE            ?= $(call remove_quote,$(CONFIG_ENGINE))
NAME              = $(GUEST_ISA)$(PLATFORM)-$(ENGINE)

# Include all filelist.mk to merge file lists
FILELIST_MK       := $(shell find -L ./src -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
DIRS-BLACKLIST-y  += $(DIRS-BLACKLIST)
SRCS-BLACKLIST-y  += $(SRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.c")
SRCS-y            += $(shell find -L $(DIRS-y) -name "*.c")
SRCS              = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))

CXXSRC-BLACKLIST-y  += $(SRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.cc")
CXXSRC-y            += $(shell find -L $(DIRS-y) -name "*.cc" -or -name "*.cpp")
CXXSRC              = $(filter-out $(CXXSRC-BLACKLIST-y), $(CXXSRC-y))

# Extract compiler and options from menuconfig
ifneq ($(CONFIG_CC),)
CC = $(call remove_quote,$(CONFIG_CC))
endif
CFLAGS_BUILD      += $(call remove_quote,$(CONFIG_CC_OPT))
CFLAGS_BUILD      += $(if $(CONFIG_CC_LTO),-flto,)
CFLAGS_BUILD      += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)
CFLAGS_BUILD      += $(if $(CONFIG_CC_ADDRASAN),-fsanitize=address,)
CFLAGS_BUILD      += $(if $(CONFIG_CC_UBASAN),-fsanitize=undefined,)
CFLAGS_TRACE      += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
CFLAGS_TRACE      += -DMTRACE_COND=$(if $(CONFIG_MTRACE_COND),$(call remove_quote,$(CONFIG_MTRACE_COND)),true)
CFLAGS_TRACE      += -DDTRACE_COND=$(if $(CONFIG_DTRACE_COND),$(call remove_quote,$(CONFIG_DTRACE_COND)),true)
CFLAGS            += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
LDFLAGS           += $(CFLAGS_BUILD)

# Include rules for menuconfig
include $(NPC_HOME)/scripts/make/config.mk

# Include rules to build NPC
include $(NPC_HOME)/scripts/make/native.mk

# Include rules to fpga
include $(NPC_HOME)/scripts/make/fpga.mk
